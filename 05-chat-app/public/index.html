<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSockets Cliente</title>

    <link rel="icon" href="./favicon.ico" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <h1>Status</h1>
    <p id="status">Connecting</p>

    <form id="login-form" style="margin-bottom: 20px">
      <input type="email" id="input-email" placeholder="Email" />
      <input type="password" id="input-password" placeholder="Password" />
      <button id="btn-login">Login</button>
    </form>

    <button id="btn-disconnect">Disconnect</button>
    <button id="btn-connect">Connect</button>

    <form id="message-form" style="display: none">
      <h1>Messages</h1>
      <select id="select-receiver">
        <option value="">Everyone</option>
        <option value="1">Eve</option>
        <option value="2">Bob</option>
        <option value="3">Charlie</option>
      </select>
      <input type="text" id="input-message" placeholder="Message" />
      <button id="send">Send</button>
    </form>

    <ul id="messages"></ul>

    <script>
      let socket;

      const status = document.querySelector("#status");
      const messageForm = document.querySelector("#message-form");
      const messageInput = document.querySelector("#input-message");
      const messagesContainer = document.querySelector("#messages");

      const btnDisconnect = document.querySelector("#btn-disconnect");
      const btnConnect = document.querySelector("#btn-connect");

      const loginForm = document.querySelector("#login-form");
      const inputEmail = document.querySelector("#input-email");
      const inputPassword = document.querySelector("#input-password");
      const btnLogin = document.querySelector("#btn-login");


      const createWebSocket = () => {
        const channelId = "mi-canal-personalizado";

        const socket = new WebSocket(
          `ws://localhost:3200?channelId=${channelId}`,
        );

        socket.onopen = () => {
          console.log("WebSocket conectado");
          messageForm.style.display = "block";
          status.textContent = "Conectado";
        };

        socket.onclose = () => {
          console.log("WebSocket desconectado");
          messageForm.style.display = "none";
          status.textContent = "Desconectado";
        };

        socket.onerror = (event) => {
          console.log({ error: event });
        };

        socket.onmessage = (event) => {
          // console.log(event.data);
          showMessage(event.data);
        };

        return socket;
      };

      socket = createWebSocket();

      btnDisconnect.addEventListener("click", () => {
        if (socket.readyState !== WebSocket.OPEN) return;
        socket.close();
      });

      btnConnect.addEventListener("click", () => {
        if (socket.readyState === WebSocket.OPEN) return;
        socket = createWebSocket();
      });

      messageForm.addEventListener("submit", (event) => {
        event.preventDefault();
        if (!messageInput.value && messageInput.value.length === 0) return;

        const message = {
          type: 'SEND_GROUP_MESSAGE', //TODO SEND DIREDT MESSAGE
          payload: {
            content: messageInput.value,
            //TODO a quien le mandamos el mensaje
        }
      }

        socket.send(JSON.stringify(message));
        // showMessage(messageInput.value);
        messageInput.value = "";
      });

      const showMessage = (message) => {
        const pre = document.createElement("pre");
        pre.innerHTML = JSON.stringify(JSON.parse(message), null, 2);

        messagesContainer.prepend(pre);
      };

      //manejo de login
      loginForm.addEventListener("submit", async(event) => {
        event.preventDefault();
        if (!inputEmail.value || inputEmail.value.length === 0) return;
        if (!inputPassword.value || inputPassword.value.length === 0) return;

        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: inputEmail.value.trim(),
            password: inputPassword.value
          })
        });

        if (!response.ok) {
          alert('Login failed');
          return;
        }
        const data = await response.json();

        document.cookie = `X-Token=${data.token}`;

        socket = createWebSocket();

      });
    </script>
  </body>
</html>
